<!DOCTYPE html>
<html>
<head>
  <title>WeFiddle - A collaborative art space.</title>
  <script src="https://cdn.firebase.com/v0/firebase.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/two.js/0.2.0/two.min.js"></script>
</head>

<body>
<script type="text/javascript">
	
  var firebaseCanvasData = new Firebase('https://wefiddle.firebaseio.com/');

  var two = new Two({
    height: 660,
    width: 660,
    autostart: true
  }).appendTo(document.body);

  var colorPallete = [
  	'rgb(0, 0, 0)',
  	'rgb(240, 60, 60)',
  	'rgb(60, 240, 60)'
  	];

  var canvasSize = 30;
  var pixelSize = 20;
  var pixelSpacing = 1;
  
  var drawingCanvas = [];

  function createBlankCanvas() {
    for (var row = 0; row < canvasSize; row++){  
      var rowData = [];
      for (var col = 0; col < canvasSize; col++){
        var rect = createPixel(row, col, colorPallete[0]);
        rowData.push({rect: rect});
        firebaseCanvasData.child(row+':'+col).set(colorPallete[0]);
      }
      drawingCanvas.push(rowData);
    }
  }

  function createPixel(row, col, color) {

    var startLeft = (two.width/2) - ((pixelSize+pixelSpacing)*canvasSize/2);
    var startTop = (two.height/2) - ((pixelSize+pixelSpacing)*canvasSize/2);

    var left = startLeft + col*(pixelSize+pixelSpacing);
    var top = startTop + row*(pixelSize+pixelSpacing);

  	var rect = two.makeRectangle(left, top, pixelSize, pixelSize);
	  rect.noStroke().fill = color;

	  rect.domElement = document.querySelector('#two-' + rect.id);
    rect.domElement.style.cursor = 'pointer';
    rect.domElement.addEventListener('click', function(e) {
        var newColor = getNextColor(rect.fill);
        rect.fill = newColor;
        firebaseCanvasData.child(row+':'+col).set(newColor);
      }, false);

    return rect;
  }

  function renderPixel(row, col, color) {
    if(!drawingCanvas[row] || !drawingCanvas[row][col] || !drawingCanvas[row][col].rect) {
      var newPixel = createPixel(row, col, color);
      drawingCanvas[row] = {};
      drawingCanvas[row][col] = newPixel;
    } else {
      var rect = drawingCanvas[row][col].rect;
      rect.fill = color;
    }
  }


  function getNextColor(currentColor) {
  	var currentIndex = colorPallete.indexOf(currentColor);
  	//console.log("Index: " + (currentIndex + 1) % colorPallete.length)
    return colorPallete[(currentIndex + 1) % colorPallete.length];
  }

  firebaseCanvasData.on('value', function(dataSnapshot) {
    if(!dataSnapshot.val()) {
      console.log("createBlankCanvas()");
      createBlankCanvas();
    }
  });

  firebaseCanvasData.on('child_added', function(childSnapshot, prevChildName) {
    console.log('New:', childSnapshot.name(), childSnapshot.val());
    
    var row = childSnapshot.name().split(':')[0];
    var col = childSnapshot.name().split(':')[1];
    var color = childSnapshot.val();

    renderPixel(row, col, color);
  });

  firebaseCanvasData.on('child_changed', function(childSnapshot, prevChildName) {
    console.log('Update:', childSnapshot.name(), childSnapshot.val());

    var row = childSnapshot.name().split(':')[0];
    var col = childSnapshot.name().split(':')[1];
    var color = childSnapshot.val();

    renderPixel(row, col, color);
  });


</script>
<div style="float: right;">
<h2>WeFiddle - A collaborative art space.</h2>
<p>Play around with the canvas below. Others can also edit it. Create art together!</p>
<p>Code on <a href="http://github.com/paramaggarwal/wefiddle">Github</a>. Created by <a href="http://twitter.com/paramaggarwal">@paramaggarwal</a>, follow me!</p>
</div>
</body>
</html>